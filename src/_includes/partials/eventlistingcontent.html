<section class="prose">
    {% if page.fileSlug != "events" %}
        {% set month = page.fileSlug %}
    {% else %}
        {% set month = helpers.currentMonth() %}
    {% endif %}

    {% if events.year %}
        {# Let's get the current year and month, e.g. 2021 Jan #}
        {% set thisMonthListings = null %}
        {% set searching = true %}

        {% for key, val in events.year %}
            {# mmm_yyyy.yaml in _data, splitting it with '_' #}
            {% set key_list = key.split('_') %}

            {% if (key_list[0] == month) and (key_list[1] == helpers.currentYear()) and searching%}
                {% set thisMonthListings = val   %}
                {% set searching = false %}
            {% endif %}
        {% endfor %}

        {#
        {% set newList = [] %}
        {% for event in  thisMonthListings.eventlistings | newItemList('diversity') | sort(attribute='start_datetime') %}
            <p>{{event.name}} --- {{event.type}}</p>
        {% endfor %}
        #}

        {% if thisMonthListings %}
            {% if page.fileSlug == "events" %}
                <h2>Latest Events this Month ({{ month }})</h2>
            {% else %}
                <h2>{{ month }} Event Listings</h2>
            {% endif %}
            {% set listings = thisMonthListings.eventlistings | newItemList('diversity') | sort(attribute='start_datetime') %}
            
            {% for event in thisMonthListings.eventlistings  | sort(attribute='start_datetime') %}
                <div class="border-solid border-1 bg-purple-50 rounded-lg p-5 mt-2">
                    <div>
                        <a href="{{ event.url }}">{{ event.name }}</a> {% if event.region %}<span class="text-xs">{{ event.region }}</span>{% endif %} {% if event.type %}<span class="text-xs bg-green-200 pr-2 pl-2">{{ event.type }}</span>{% endif %} {% if event.new %}<span class="bg-yellow-200 text-xs pl-2 pr-2">New</span>{% endif %}
                    </div>
                    <div>
                        When: {{ event.start_datetime | readableDateTime() }}
                    </div>
                </div>
            {% endfor %}


            
        {% else %}
            Listings not found
        {% endif %}
    {% endif %}
    
    </section>